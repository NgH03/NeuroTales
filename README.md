# NeuroTales
NeuroTales是一套轻量级的，用于实时评估大脑状态的系统。
> 基于Timeflux框架开发

### prompt

```
你是一位专业的脑科学专家，特别在专注力的分析和辅助训练方面有很高的建树，现在，请根据以下数据生成一份专注力检测报告：

用户信息：
- 年龄：21
- 性别：男

专注力数据分析：
- 专注力数值（每三秒记录一次，由 beta / (alpha + theta) 计算得来）：[0.895,0.869,0.853,0.759,0.821,0.819,0.784,0.816,0.857,0.875,0.833,0.826,0.831,0.804,0.835,0.873,0.828,0.808,0.732,0.763,0.754,0.743,0.886,0.903,0.836,0.771,0.731,0.733,0.728,0.744,0.674,0.715,0.69,0.822,0.849,0.784,0.821,0.722,0.78,0.772,0.699,0.682,0.65,0.73,0.785,0.793,0.865,0.76,0.798,0.794,0.838,0.839,0.809,0.825,0.747,0.873,0.933,0.938,0.925,0.88,0.808,0.822]
- 放松度数值（每三秒记录一次，由 alpha 计算得来））: []

生成的报告应包含以下部分：
1. 专注力状态分类（走神/一般/专注）及各状态持续时间：[按数据分类并计算时间]，专注力变化趋势：[描述趋势]
2. 结果总览：总结专注力和放松能力的得分及简要描述。
3. 详细测评分析：展示专注力和放松能力的变化图表，并给予评价。
4. 六维度专注力和行为习惯：结合数据对用户的专注力表现进行多维度分析。
5. 推荐解决方案：根据测评结果提供个性化的训练建议。

报告风格应专业、清晰，并包含数据说明和改进建议。
```


timeflux {
    专注力：engagement index: []  == beta / (alpha + theta)
    放松程度：alpha: [] == alpha
} -> langchain4j {
    prompt(userinfo, eeg, historyinfo)
} -> LLM -> Markdown

技术选型
1. 预处理：Timeflux
2. 服务端：Langchain4j
3. 存储: MongoDB

模块划分
信号采集 -> 预处理 -> 服务端 -> 可视化

### 数据流向

1. EEG信号：
   - 支持在实时录制、上传两种方式
   - 格式为.hd5f
   - 源文件存储在MinIO，用户ID目录下
2. EI（专注力 + 放松度 + 信号图）：
   - 上传、录制后自动由预处理模块解析获得
   - 格式为int[]，图片存储在MinIO
   - 数据存储在MongoDB，存储在用户ID和文件名下
3. prompt：
    - 用户点击开始分析，服务端拼接获得
    - 格式为string，包含模板和userMessages
    - 数据存储在MongoDB，存储在用户ID和文件名目录下
4. Result:
   - AI返回获得
   - 格式为string
   - 数据存储在MongoDB

### 开发步骤：

1. 确立数据存储 - MongoDB

  - 用户信息集合：
    - 用户信息 - 年龄 + 性别
    - 账户信息 - 账户名 + 密码
    - LLM会话信息 - id + 名称
    - EEG数据信息 - id + 名称
  - LLM会话集合：
    - 会话ID + 会话内容
  - EEG数据集合：
    - id + 文件存储在MinIO的key

2. 确立交互范式
   
    - **开发用户管理模块：**用户从前端交互，输入用户名登录（没有账号就创建一个，有的话就登录查到所有的数据集）
    
      > AOP实现HTTP Header解析器校验登陆账号，30min退出登录，信息使用原生ThreadLocal存储
    
    - **开发离线信号处理：**EEG录制和解析分离，录制可实时生成EI和alpha，解析接受.hdf5格式，参考lsl->hd5f的保存方式
    
    - **开发预处理main.py控制台：**server直接执行python命令启动录制&解析（跨docker容器调度）
    
    - **开发.hd5f数据上传模块：**上传后自动解析，解析失败则删除不占用服务器存储，预处理立即返回，python日志输出到单独日志，收集返回HTTP回调


3. 功能升级
   - RAG知识库检索：后台知识库RAG，个人知识库
   - 升级模型 + 升级专注力检测算法 + 升级prompt





#### MongoDB

##### database - neurotales

1. collection - users

   ```json
   /** 
   * Paste one or more documents here
   */
   {
     "_id": {
       "$oid": "64a5f3b9c1b2d3e4f5g6h7i8"
     },
     "accountId": "账户名称",
     "password": "",
     "gender": "male",
     "birthDate": "2003-11-03",
     "sessionInfos": [
       {
         "sessionId": "65b6c7d8e9f0a1b2c3d4e5f6",
         "sessionName": "会话名称"
       }
     ],
     "eegInfos": [
       {
         "datasetId": "66c7d8e9f0a1b2c3d4e5f6a7",
         "sessionName": "数据集名称",
         "isProcessed": false
          
       }
     ]
   }
   ```

2. collection - datasets

   ```json
   // document example
   {
     "_id": {
       "$oid": "6856336a7725fe96838509e7"
     },
     "eegFile": "MinIO的key",
     "eiValues": [0.22, 0.23],
     "alphaValues": [0.5, 0.2],
     "pictureFile": "MinIO的key"
   }
   ```

3. collection - sessions

   ```json
   // document example
   {
     "_id": {
       "$oid": "6856336a7725fe96838509e7"
     },
     "memoryId": 1,
     "content": "[{\"text\": \"你是一个专业的……\"}]"
   }
   ```



### 接口文档



rate越高，输出更频繁

3000：0.05秒



2.315,0.956,0.711,1.596,1.938,1.91,1.151,1.159,1.331,1.813,1.406,1.148,1.056,1.78,2.387,1.728,0.784,0.87,1.639,2.377,1.124,0.88,0.681,1.473,2.58,1.633,0.73,0.674,1.892,2.443,1.299,0.919,1.591,1.904,2.277,1.633,0.759,1.129,1.74,nan,nan,nan,nan

2.002,1.089,1.364,1.873,1.518,1.774,1.615,1.189,1.857,1.926,1.059,1.602,1.717,1.278,1.364,1.069,1.314,1.809,1.311,1.374,1.548,1.227,1.325,1.586,1.171,1.421,1.772,1.177
